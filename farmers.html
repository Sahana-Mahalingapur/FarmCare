<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Farm Care | Farmer Dashboard</title>
    <link rel="stylesheet" href="farmers.css" />
</head>

<body>
    <header>
        <h1>ðŸŒ¿ Farm Care â€” Farmer Dashboard</h1>
        <nav>
            <a href="home.html">Home</a>
            <a href="#">My Uploads</a>
            <a href="#" id="logout-btn">Logout</a>
        </nav>
    </header>

    <main>
        <section class="upload-section">
            <h2>Upload Your Fresh Produce</h2>
            <p>Share your farmers freshest harvest with consumers directly!</p>

            <form id="uploadForm">
                <label for="produce-name">Produce Name:</label>
                <input type="text" id="produce-name" placeholder="e.g. Mangoes, Tomatoes" required />

                <!-- Added Price Field -->
                <label for="produce-price">Price (â‚¹):</label>
                <input type="number" id="produce-price" placeholder="e.g. 50" required />

                <!-- Added Category Field -->
                <label for="produce-category">Category:</label>
                <select id="produce-category" required
                    style="width: 100%; padding: 0.8rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="Vegetables">Vegetables</option>
                    <option value="Fruits">Fruits</option>
                    <option value="Dairy">Dairy</option>
                    <option value="Grains">Grains</option>
                    <option value="Other">Other</option>
                </select>

                <label for="harvest-date">Harvest Date:</label>
                <input type="date" id="harvest-date" required />

                <label for="freshness">Freshness Scale (1â€“10):</label>
                <div class="freshness-scale">
                    <input type="range" id="freshness" min="1" max="10" value="8"
                        oninput="updateFreshness(this.value)" />
                    <span id="freshness-value">8 / 10 ðŸŒ±</span>
                </div>

                <label for="produce-image">Upload Produce Image:</label>
                <input type="file" id="produce-image" accept="image/*" required />

                <button type="submit">Upload </button>
            </form>
        </section>

        <section class="preview-section">
            <h3>My Uploaded Produce</h3>
            <p>Your recently uploaded fruits and vegetables will appear below.</p>
            <div id="preview-grid" class="preview-grid">
                <!-- Farmerâ€™s uploaded items will appear here dynamically -->
                <p>Loading...</p>
            </div>
        </section>
    </main>

    <footer>
        <p>Â© 2025 Farm Care | Empowering Farmers with Technology ðŸŒ¾</p>
    </footer>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'login.html';

        // Logout
        document.getElementById("logout-btn").onclick = () => {
            localStorage.clear();
            window.location.href = "login.html";
        };

        // Update freshness value display
        function updateFreshness(val) {
            const valueText = document.getElementById("freshness-value");
            const emojis = ["ðŸ˜", "ðŸ™‚", "ðŸ˜Š", "ðŸ˜", "ðŸ˜„", "ðŸ˜ƒ", "ðŸ˜‹", "ðŸ¥°", "ðŸŒ¿", "ðŸ’š"];
            valueText.textContent = `${val} / 10 ${emojis[val - 1]}`;
        }

        // Load Products
        async function loadProducts() {
            try {
                const res = await fetch('http://localhost:5000/api/products');
                const data = await res.json();
                const grid = document.getElementById("preview-grid");
                grid.innerHTML = '';

                if (data.success) {
                    const currentUserEmail = localStorage.getItem('email');

                    // Filter products by current user's email
                    const myProducts = data.data.filter(product =>
                        product.farmer && product.farmer.email === currentUserEmail
                    );

                    if (myProducts.length === 0) {
                        grid.innerHTML = '<p>No uploads found for this account.</p>';
                        return;
                    }

                    myProducts.forEach(product => {
                        const card = document.createElement("div");
                        card.classList.add("card");
                        // Use uploaded image or placeholder
                        const imgUrl = product.image.startsWith('http') || product.image.startsWith('/') ? product.image : '/uploads/' + product.image;

                        card.innerHTML = `
                      <img src="${imgUrl}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/150'">
                      <h4>${product.name}</h4>
                      <p>Price: â‚¹${product.price}</p>
                      <p>Harvested: ${new Date(product.harvestDate).toLocaleDateString()}</p>
                      <p>Freshness: ${product.freshness}/10 ðŸŒ¿</p>
                      <button class="delete-btn" onclick="deleteProduct('${product._id}')" style="
                          background: #d9534f;
                          color: white;
                          border: none;
                          padding: 5px 10px;
                          border-radius: 5px;
                          cursor: pointer;
                          margin-top: 10px;
                          width: 100%;
                      ">Delete</button>
                    `;
                        grid.prepend(card);
                    });
                }
            } catch (err) {
                console.error(err);
                document.getElementById("preview-grid").innerHTML = '<p>Error loading products.</p>';
            }
        }

        // Delete Product
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;

            try {
                const res = await fetch(`http://localhost:5000/api/products/${productId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await res.json();

                if (data.success) {
                    alert('Product deleted successfully');
                    loadProducts(); // Reload grid
                } else {
                    alert(data.error || 'Failed to delete product');
                }
            } catch (err) {
                console.error(err);
                alert('Error connecting to server');
            }
        }

        // Handle form submission
        const form = document.getElementById("uploadForm");

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const name = document.getElementById("produce-name").value;
            const price = document.getElementById("produce-price").value;
            const category = document.getElementById("produce-category").value;
            const date = document.getElementById("harvest-date").value;
            const freshness = document.getElementById("freshness").value;
            const fileInput = document.getElementById("produce-image");
            const file = fileInput.files[0];

            if (!file) return alert("Please upload an image!");

            try {
                // 1. Upload Image
                const formData = new FormData();
                formData.append('image', file);

                const uploadRes = await fetch('http://localhost:5000/api/upload', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const uploadData = await uploadRes.json();

                if (!uploadRes.ok) throw new Error(uploadData.message || 'Image upload failed');

                const imageUrl = uploadData.imageUrl;

                // 2. Create Product
                const productData = {
                    name,
                    description: `${name} - Fresh from farm`,
                    price,
                    category,
                    stock: 10, // Default stock
                    freshness,
                    harvestDate: date,
                    image: imageUrl
                };

                const productRes = await fetch('http://localhost:5000/api/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(productData)
                });
                const productResult = await productRes.json();

                if (productResult.success) {
                    alert('Product uploaded successfully!');
                    form.reset();
                    document.getElementById("freshness-value").textContent = "8 / 10 ðŸŒ±";
                    loadProducts();
                } else {
                    alert(productResult.error || 'Failed to create product');
                }

            } catch (err) {
                console.error(err);
                alert('Error: ' + err.message);
            }
        });

        loadProducts();
    </script>
</body>

</html>